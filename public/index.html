<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    
    <div class="page">
      <h1>Job Hunt HQ</h1>
      <div class="container">
        <form id="form">
          <label for="searchList">Search Role List:</label>
          <input type="text" id="searchList" name="searchList" placeholder="ex. software engineer, junior engineer" required/>
          <label for="urlList">Url List:</label>
          <input type="text" id="urlList" name="urlList" placeholder="ex. https://url.com, https://url.com" required/>
          <span class="seperateSpan"></span>
          <div class="form-centered">
            <button id="modalBtn">
              <input type="submit"/>
            </button>
          </div>
        </form>
      </div>
      <div class="blank"></div>
    </div>
    
    </div>

    <!-- Modal -->
    <div  id="outputModal" class="modal">
      <div class="modal-frame">
        <div class="modal-content">
          <span class="close">&times;</span>
          <div id="output"></div>      
        </div>
      </div>
    </div>

  </body>
    <script>
    
      // const searchArr = []
      // const paramStr = window.location.search
      // console.log(paramStr);
      // const searchParams = new URLSearchParams(paramStr);
      // console.log(searchParams);
      // searchParams.forEach(currParam => {searchArr.push(currParam)});    

        //Modal
      const modal = document.getElementById("outputModal");
      const btn = document.getElementById("modalBtn");
        //span element that closes modal
      const span = document.getElementsByClassName("close")[0];

      btn.onclick = () => {
        modal.style.display = "block"; // open modal
      };

      span.onclick = () => {
        modal.style.display = "none"; // close modal
      };
      
      const handleForm = async(e) => {
        e.preventDefault();
        document.getElementById("output").innerHTML = 'Loading.....'
        try {
          const formData = new FormData((e.target))
          const dataArr = [...formData.entries()];

          const backEnd = await fetch('/api/jobs', 
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
              // 'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify(dataArr)
          });


          const response = await backEnd.json();
          
          const output = `
            <span>
              ${Object.keys(response).map((currUrl) => {
                //cleanup url for innerHTML
                const urlObj = new URL(currUrl);
                const shortUrl = urlObj.origin;
                const betterUrl = currUrl.split('?');
                return `
                  <ul>
                    <a href=${currUrl}>${betterUrl[0]}</a>
                    ${response[currUrl].map((currJob) => {
                      return `<li>${currJob}</li>`
                    }).join('')}
                  </ul>`
              }).join('')}
            </span>
          `

          document.getElementById("output").innerHTML = output
          
        } catch(err) {
          console.log(err);
        }
      };


        //Form handling
      const form = document.getElementById("form");
      form.addEventListener('submit', handleForm);

    </script>
</html>