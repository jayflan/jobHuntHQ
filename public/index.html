<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    
    <div class="page">
      <h1>Job Hunt HQ</h1>
      <div class="container">
        <form id="form">
          <label for="searchList">Search Role List:</label>
          <input type="text" id="searchList" name="searchList" placeholder="ex. software engineer, junior engineer" required/>
          <label for="urlList">Url List:</label>
          <input type="text" id="urlList" name="urlList" placeholder="ex. https://url.com, https://url.com" required/>
          <span class="seperateSpan"></span>
          <div class="form-centered">
            <button id="modalBtn">
              <input type="submit"/>
            </button>
          </div>
        </form>
      </div>
      <div class="blank"></div>
    </div>
    
    <!-- </div> -->

    <!-- Modal -->
    <div  id="outputModal" class="modal">
      <div class="modal-frame">
        <div class="modal-content">
          <span class="close">&times;</span>
          <div id="output"></div>      
        </div>
      </div>
    </div>

  </body>
    <script>
        //Modal
      const modal = document.getElementById("outputModal");
      const btn = document.getElementById("modalBtn");
        //span element that closes modal
      const span = document.getElementsByClassName("close")[0];

      btn.onclick = () => {
        modal.style.display = "block"; // open modal
      };

      span.onclick = () => {
        modal.style.display = "none"; // close modal
      };
      

      const handleForm = async(e) => {
        e.preventDefault();
        document.getElementById("output").innerHTML = 'Loading.....'
        try {
          const formData = new FormData((e.target))
          const dataArr = [...formData.entries()];

            // convert payload array into 1 searchPhrase array & 1 url array
          const createNewArray = (payloadArr, arrElement) => {
            const newArr = [...payloadArr[arrElement][1].split(',')]
            return newArr.map(currElem => currElem.trim());
          };
          const searchPhraseArr =  createNewArray(dataArr, 0);
          const urlArr = createNewArray(dataArr, 1);

          const serverlessUrl = "https://hfzbukzscd.execute-api.us-east-1.amazonaws.com/latest";  // aws API gateway url
          // const serverlessUrl = "/lambda"; // direct-local path for aws function testing
          // const serverlessUrl = "http://localhost:3000";

          
            // scrape urls
          let urlObj = {}
          for(let i = 0; i < urlArr.length; i++) {
            document.getElementById("output").innerHTML = `Processing Company Urls: ${i+1} of ${urlArr.length} `
            const urlScraped = await fetch(serverlessUrl + "/api/webscraper",
              {
                method: 'POST',
                headers: {
                  "Content-Type": "application/json",
                  "Access-Control-Allow-Origin": "http://localhost:3000"
                  // "Access-Control-Allow-Origin": "https://resilient-buttercream-2379bc.netlify.app"
                },
                body: JSON.stringify({"urlStr": urlArr[i]})
              });
              const response = await urlScraped.text();
              urlObj[urlArr[i]] = response;
          };

          document.getElementById("output").innerHTML = "Finalizing Output";

          const scrapedUrlObj = await urlObj;


            // search scraped urls for search phrases
          const searchResults = await fetch(serverlessUrl + "/api/search", 
            {
              method: 'POST',
              headers: {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "http://localhost:3000"
                // "Access-Control-Allow-Origin": "https://resilient-buttercream-2379bc.netlify.app"
              },
              body: JSON.stringify({searchArr: searchPhraseArr, scrapedUrlObj: scrapedUrlObj })
            });

            const response = await searchResults.json();
            // console.log(response);
          
          const output = `
            <span>
              ${Object.keys(response).map((currUrl) => {
                //cleanup url for innerHTML
                const urlObj = new URL(currUrl);
                const shortUrl = urlObj.origin;
                const betterUrl = currUrl.split('?');
                return `
                  <ul>
                    <a href=${currUrl}>${betterUrl[0]}</a>
                    ${response[currUrl].map((currJob) => {
                      return `<li>${currJob}</li>`
                    }).join('')}
                  </ul>`
              }).join('')}
            </span>
          `
          document.getElementById("output").innerHTML = output;
          
        } catch(err) {
          console.log(err);
        }
      };


        //Form handling
      const form = document.getElementById("form");
      form.addEventListener('submit', handleForm);

    </script>
</html>